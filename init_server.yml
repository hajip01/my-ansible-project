---
- name: æœåŠ¡å™¨æ‰¹é‡åˆå§‹åŒ–ï¼ˆå­¦ä¹ ç‰ˆï¼‰
  hosts: new_servers  # å¯¹æ–°æœåŠ¡å™¨ç»„æ‰§è¡Œ
  become: yes
  
  # å®šä¹‰å˜é‡
  vars:
    # è¿ç»´è´¦æˆ·è®¾ç½®
    ops_user: "ops"
    
    # è¦å®‰è£…çš„åŸºç¡€å·¥å…·
    base_tools: ['curl', 'git', 'vim', 'htop', 'wget', 'net-tools', 'tree']
    
    # æœåŠ¡å™¨åˆ«åæ˜ å°„ï¼ˆä¸ºäº†è®©æ¯å°"æ¨¡æ‹ŸæœåŠ¡å™¨"æœ‰ä¸åŒçš„ä¸»æœºåï¼‰
    server_names:
      server-new-01: "web-dev-01"
      server-new-02: "web-dev-02"
      server-new-03: "db-dev-01"
  
  # ä»»åŠ¡åˆ—è¡¨
  tasks:
    # ä»»åŠ¡0ï¼šæ˜¾ç¤ºå¼€å§‹ä¿¡æ¯
    - name: æ˜¾ç¤ºåˆå§‹åŒ–å¼€å§‹ä¿¡æ¯
      debug:
        msg: "ğŸš€ å¼€å§‹åˆå§‹åŒ–æœåŠ¡å™¨ï¼š{{ inventory_hostname }} (å®é™…IP: {{ ansible_default_ipv4.address }})"
    
    # ä»»åŠ¡1ï¼šè®¾ç½®ä¸åŒä¸»æœºåï¼ˆæ¨¡æ‹Ÿå¤šæœåŠ¡å™¨çš„å…³é”®ï¼‰
    - name: è®¾ç½®æœåŠ¡å™¨ä¸»æœºå
      hostname:
        name: "{{ server_names[inventory_hostname] }}"
      when: inventory_hostname in server_names
    
    # ä»»åŠ¡2ï¼šæ›´æ–°ç³»ç»Ÿ
    - name: æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
      apt:
        update_cache: yes
      tags: update
    
    # ä»»åŠ¡3ï¼šå®‰è£…åŸºç¡€å·¥å…·ï¼ˆä½¿ç”¨å¾ªç¯ï¼‰
    - name: å®‰è£…åŸºç¡€å·¥å…·
      apt:
        name: "{{ item }}"
        state: present
      loop: "{{ base_tools }}"
      tags: install
    
    # ä»»åŠ¡4ï¼šåˆ›å»ºè¿ç»´ç”¨æˆ·
    - name: åˆ›å»ºè¿ç»´ç”¨æˆ·
      user:
        name: "{{ ops_user }}"
        shell: /bin/bash
        groups: sudo
        create_home: yes
      tags: user
    
    # ä»»åŠ¡5ï¼šé…ç½®è¿ç»´ç”¨æˆ·SSHå…¬é’¥
    - name: é…ç½®SSHå…¬é’¥
      authorized_key:
        user: "{{ ops_user }}"
        state: present
        key: "{{ lookup('file', '~/.ssh/id_rsa.pub') }}"
      tags: user
    
    # ä»»åŠ¡6ï¼šé…ç½®æ—¶åŒº
    - name: é…ç½®ä¸Šæµ·æ—¶åŒº
      timezone:
        name: Asia/Shanghai
      tags: config
    
    # ä»»åŠ¡7ï¼šç®€å•å®‰å…¨é…ç½®
    - name: é…ç½®SSHå®‰å…¨é€‰é¡¹
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: '^#?PermitRootLogin'
        line: 'PermitRootLogin no'
        state: present
      notify: é‡å¯SSHæœåŠ¡
      tags: security
    
    # ä»»åŠ¡8ï¼šæ˜¾ç¤ºå®Œæˆä¿¡æ¯
    - name: æ˜¾ç¤ºåˆå§‹åŒ–å®Œæˆä¿¡æ¯
      debug:
        msg: |
          âœ… æœåŠ¡å™¨ {{ inventory_hostname }} åˆå§‹åŒ–å®Œæˆï¼
          
          å®é™…ä¸»æœºåï¼š{{ ansible_hostname }}
          IPåœ°å€ï¼š{{ ansible_default_ipv4.address }}
          æ“ä½œç³»ç»Ÿï¼š{{ ansible_distribution }} {{ ansible_distribution_version }}
          
          å·²é…ç½®ï¼š
          - ä¸»æœºåï¼š{{ server_names[inventory_hostname] | default('æœªé‡å‘½å') }}
          - è¿ç»´ç”¨æˆ·ï¼š{{ ops_user }}
          - å·²å®‰è£… {{ base_tools | length }} ä¸ªå·¥å…·
          - æ—¶åŒºï¼šAsia/Shanghai
          
          å¯ä»¥é€šè¿‡ä»¥ä¸‹å‘½ä»¤ç™»å½•ï¼š
          ssh {{ ops_user }}@{{ ansible_default_ipv4.address }}
      tags: info
  
  # å¤„ç†ç¨‹åº
  handlers:
    - name: é‡å¯SSHæœåŠ¡
      service:
        name: ssh
        state: restarted
      tags: security
